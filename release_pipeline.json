{
  "stages": [
    {
      "name": "build",
      "jobs": [
        [
          {
            "build_release_apk_for_testing": {
              "artifacts": [
                "app/build/outputs/apk/soundcloud*.apk"
              ],
              "cmd": "BUILD_TYPE=releaseNoProguard ./gradlew -Dhttp.proxyHost=proxy-development.int.s-cloud.net -Dhttp.proxyPort=3128 buildReleaseNoProguard",
              "plugins": {
                "androidLint": {
                  "failedTotalHigh": 0,
                  "failedTotalNormal": 0,
                  "pattern": "app/build/outputs/lint-results-prodDebug.xml"
                },
                "findbugs": {
                  "pattern": "app/build/reports/findbugs/findbugs.xml"
                },
                "pmd": {
                  "pattern": "app/build/reports/pmd/pmd.xml"
                },
                "taskPublisher": {
                  "excludePattern": "app/target/**/*",
                  "pattern": "app/**/*.*"
                },
                "violations": {
                  "checkstyle": {
                    "pattern": "app/build/reports/checkstyle/checkstyle.xml"
                  }
                }
              }
            }
          },
          {
            "build_test_apk": {
              "cmd": "http_proxy=proxy-development.int.s-cloud.net:3128 BUILD_TYPE=releaseNoProguard ./gradlew -Dhttp.proxyHost=proxy-development.int.s-cloud.net -Dhttp.proxyPort=3128 clean assembleAcceptanceTest downloadNetworkManagerApkCI",
              "artifacts": [
                "app/build/outputs/apk/*androidTest*.apk",
                "app/build/outputs/apk/androidnetworkmanager-*.apk"
              ]
            }
          }
        ]
      ],
      "next-stages": [
        "automated_tests"
      ]
    },
    {
      "name": "automated_tests",
      "jobs": [
        [
          {
            "unit_tests": {
              "cmd": "./gradlew -Dhttp.proxyHost=proxy-development.int.s-cloud.net -Dhttp.proxyPort=3128 runUnitTests",
              "test-reports": "**/build/test-results/**/*.xml,tests-robolectric/build/test-results/*.xml",
              "no-clean": true,
              "plugins": {
                "htmlReports": [
                  {
                    "reportDir": "tests-robolectric/build/reports/tests/",
                    "reportFiles": "index.html",
                    "reportName": "Legacy test report"
                  },
                  {
                    "reportDir": "app/build/reports/tests/devDebug/",
                    "reportFiles": "index.html",
                    "reportName": "Unit test report"
                  }
                ]
              }
            }
          },
          {
            "acceptance_tests": {
              "cmd": "BUILD_TYPE=releaseNoProguard ./gradlew runLollipopTestsRelease",
              "test-reports": "results/xml/*.xml",
              "plugins": {
                "htmlReports": [
                  {
                    "reportDir": "results/",
                    "reportFiles": "index.html",
                    "reportName": "Test Results"
                  }
                ],
                "extEmail": {
                  "content": "&lt;p&gt;${SCRIPT, template=&quot;random-gif.template&quot;}&lt;/p&gt;${SCRIPT, template=&quot;ios.template&quot;}"
                }
              }
            }
          }
        ]
      ],
      "next-stages": [
        "deploy_beta",
        "release_checklist",
        "manual_tests"
      ]
    },
    {
      "name": "release_checklist",
      "jobs": [
        {
          "create_release_checklist": {
            "cmd": "bundle install && bundle exec rake github:release_checklist",
            "manual": true
          }
        }
      ]
    },
    {
      "name": "manual_tests",
      "jobs": [
        {
          "create_regression_tests_tasks": {
            "cmd": "bundle install && bundle exec rake github:regression_tests",
            "manual": true,
            "localBranch": true
          }
        }
      ]
    },
    {
      "name": "deploy_beta",
      "jobs": [
        {
          "build_beta_apk": {
            "cmd": "BUILD_TYPE=beta ./gradlew -Dhttp.proxyHost=proxy-development.int.s-cloud.net -Dhttp.proxyPort=3128 buildBeta",
            "artifacts": [
              "app/build/outputs/apk/soundcloud*.apk"
            ]
          }
        },
        {
          "testdroid_smoke_tests": {
            "cmd": "cp app/build/outputs/apk/soundcloud-android*$PIPELINE_VERSION*.apk app/build/outputs/apk/soundcloud-android-testdroid.apk",
            "plugins": {
              "testdroid": {
                "appPath": "app/build/outputs/apk/soundcloud-android-testdroid.apk",
                "deviceGroupId": "2269",
                "projectId": "29091428",
                "notificationEmail": "android-dev@soundcloud.com"
              }
            },
            "manual": true,
            "artifacts": [
              "app/build/outputs/apk/soundcloud-android-*-beta-*.apk"
            ]
          }
        },
        {
          "deploy_beta": {
            "cmd": "ln -s /home/mobile/installs/client_secrets.json client_secrets.json \nbundle install \n./gradlew -Dhttp.proxyHost=proxy-development.int.s-cloud.net -Dhttp.proxyPort=3128 deployBeta versionizeFollowUpBeta commitVersionBump",
            "manual": true,
            "localBranch": true,
            "artifacts": [
              "app/build/outputs/apk/soundcloud-android-*-beta-*.apk"
            ]
          }
        }
      ],
      "next-stages": [
        "rollout_release"
      ]
    },
    {
      "name": "rollout_release",
      "jobs": [
        [
          {
            "build_release_apk": {
              "cmd": "BUILD_TYPE=release ./gradlew -Dhttp.proxyHost=proxy-development.int.s-cloud.net -Dhttp.proxyPort=3128 buildRelease",
              "artifacts": [
                "app/build/outputs/apk/soundcloud*.apk"
              ]
            }
          },
          {
            "build_follow_up_beta_apk": {
              "cmd": "BUILD_TYPE=beta ./gradlew -Dhttp.proxyHost=proxy-development.int.s-cloud.net -Dhttp.proxyPort=3128 buildFollowUpBeta",
              "artifacts": [
                "app/build/outputs/apk/soundcloud*.apk"
              ]
            }
          }
        ],
        {
          "rollout_release_1_percent_and_followup_beta": {
            "cmd": "ln -s /home/mobile/installs/client_secrets.json client_secrets.json \nbundle install \n./gradlew -Dhttp.proxyHost=proxy-development.int.s-cloud.net -Dhttp.proxyPort=3128 deployReleaseOnePercent deployFollowUpBeta",
            "manual": true,
            "localBranch": true,
            "artifacts": [
              "app/build/outputs/apk/soundcloud-android-*.apk"
            ]
          }
        },
        {
          "rollout_release_5_percent": {
            "cmd": "ln -s /home/mobile/installs/client_secrets.json client_secrets.json \nbundle install \n./gradlew -Dhttp.proxyHost=proxy-development.int.s-cloud.net -Dhttp.proxyPort=3128 deployReleaseFivePercent",
            "manual": true,
            "localBranch": true,
            "artifacts": [
              "app/build/outputs/apk/soundcloud-android-*-release-*.apk"
            ]
          }
        },
        {
          "rollout_release_100_percent": {
            "cmd": "ln -s /home/mobile/installs/client_secrets.json client_secrets.json \nbundle install \n./gradlew -Dhttp.proxyHost=proxy-development.int.s-cloud.net -Dhttp.proxyPort=3128 deployReleaseRolloutFull",
            "manual": true,
            "localBranch": true,
            "artifacts": [
              "app/build/outputs/apk/soundcloud-android-*-release-*.apk"
            ]
          }
        }
      ]
    }
  ],
  "settings": {
    "default-name": "Android_Listeners_Release",
    "git-branch": "release",
    "git-url": "git@github.com:soundcloud/SoundCloud-Android.git",
    "github-url": "https://github.com/soundcloud/SoundCloud-Android/",
    "jenkins-server": "http://mobile-jenkins.int.s-cloud.net",
    "owner-emails": "android-dev@soundcloud.com",
    "slave-label": "mobile-slave"
  }
}

