{
  "stages": [
    {
      "name": "build",
      "jobs": [
        [ 
          { 
            "compile": { 
              "artifacts": [
                "app/res/values/app_properties.xml", 
                "app/build/outputs/apk/soundcloud*.apk"
              ],
              "cmd": "BUILD_TYPE=releaseNoProguard ./gradlew clean updateVersion buildReleaseNoProguardCI", 
              "plugins": {
                "androidLint": {
                  "failedTotalHigh": 0, 
                  "failedTotalNormal": 0, 
                  "pattern": "app/build/outputs/lint-results-prodDebug.xml"
                },
                "findbugs": {
                  "pattern": "app/build/reports/findbugs/findbugs.xml"
                }, 
                "pmd": {
                  "pattern": "app/build/reports/pmd/pmd.xml"
                }, 
                "taskPublisher": {
                  "excludePattern": "app/target/**/*", 
                  "pattern": "app/**/*.*"
                }, 
                "violations": {
                  "checkstyle": {
                      "pattern": "app/build/reports/checkstyle/checkstyle.xml"
                  }
                } 
              }
            }
          }, 
          {
            "compile_test_apk": {
              "cmd": "BUILD_TYPE=releaseNoProguard ./gradlew clean assembleAcceptanceTest; ./gradlew downloadNetworkManagerApkCI",
              "artifacts": [
                "app/build/outputs/apk/*androidTest*.apk", 
                "app/build/outputs/apk/androidnetworkmanager-*.apk", 
                "app/src/androidTest/res/values/test_properties.xml"
              ]
            }
          },
          {
            "compile_beta_apk": {
              "cmd": "BUILD_TYPE=beta ./gradlew clean updateVersion buildBetaCI",
              "artifacts": [
                "app/res/values/app_properties.xml", 
                "app/build/outputs/apk/soundcloud-android*beta.apk" 
              ] 
            }
          },
          {
            "compile_release_apk": {
              "cmd": "BUILD_TYPE=release ./gradlew clean updateVersion buildReleaseCI",
              "artifacts": [
                "app/res/values/app_properties.xml", 
                "app/build/outputs/apk/soundcloud-android-*-release.apk"
              ]   
            }
          }

        ]
      ],
      "next-stages": [ "test" ]
    }, 
    { 
      "name": "test",
      "jobs": [
        [
          { "unit_tests": {
              "cmd": "BUILD_TYPE=release ./gradlew runUnitTests", 
              "test-reports": "**/build/test-results/**/*.xml,tests-robolectric/build/test-results/*.xml",
              "no-clean": true,
              "plugins": {
                "htmlReports": [
                  {
                    "reportDir": "tests-robolectric/build/reports/tests/", 
                    "reportFiles": "index.html", 
                    "reportName": "Legacy test report"
                  }, 
                  {
                    "reportDir": "app/build/reports/tests/devDebug/", 
                    "reportFiles": "index.html", 
                    "reportName": "Unit test report"
                  }
                ]
              }
            } 
          },
          { "acceptance_tests": {
              "cmd": "BUILD_TYPE=releaseNoProguard ./gradlew runKitKatTestsRelease", 
              "test-reports": "results/xml/*.xml",
              "plugins": {
                "htmlReports": [
                  {
                    "reportDir": "results/", 
                    "reportFiles": "index.html", 
                    "reportName": "Test Results"
                  }
                ],
                "extEmail": {
                  "content": "&lt;p&gt;${SCRIPT, template=&quot;random-gif.template&quot;}&lt;/p&gt;${SCRIPT, template=&quot;ios.template&quot;}"
                }
              }
            } 
          },
          { "testdroid_smoke_tests": {
              "cmd": "cp app/build/outputs/apk/soundcloud-android-*releaseNoProguard.apk app/build/outputs/apk/soundcloud-android-testdroid.apk"
            }
          }
        ]
      ],
      "next-stages": [ "deploy" ]
    }, 
    {
      "name": "deploy",
      "jobs": [
        { "deploy_beta": {
            "cmd": "BUILD_TYPE=beta bundle install && ./gradlew deployBeta", 
            "manual": true,
            "localBranch": true, 
            "artifacts": ["app/res/values/app_properties.xml", "app/build/outputs/apk/soundcloud*.apk"]
          } 
        },
        { 
          "rollout_release_1_percent": {
            "cmd": "BUILD_TYPE=release bundle install && ./gradlew deployOnePercent", 
            "manual": true,
            "localBranch": true,
            "artifacts": ["app/res/values/app_properties.xml", "app/build/outputs/apk/soundcloud-android-*-release.apk"]
          } 
        },
        { 
          "rollout_release_5_percent": {
            "cmd": "BUILD_TYPE=release bundle install && ./gradlew deployFivePercent", 
            "manual": true,
            "localBranch": true,
            "artifacts": ["app/res/values/app_properties.xml", "app/build/outputs/apk/soundcloud-android-*-release.apk"]
          } 
        },
        { 
          "deploy_release": {
            "cmd": "BUILD_TYPE=release bundle install && ./gradlew rolloutFull", 
            "manual": true,
            "localBranch": true,
            "artifacts": ["app/res/values/app_properties.xml", "app/build/outputs/apk/soundcloud-android-*-release.apk"]
          } 
        }
      ]   
    }
  ],
  "settings": {
    "default-name": "Android_Listeners_Release", 
    "git-branch": "release",
    "git-url": "git@github.com:soundcloud/SoundCloud-Android.git", 
    "github-url": "https://github.com/soundcloud/SoundCloud-Android/", 
    "jenkins-server": "http://mobile-jenkins.int.s-cloud.net", 
    "owner-emails": "slawomir@soundcloud.com", 
    "slave-label": "mobile-slave"
  }
}

