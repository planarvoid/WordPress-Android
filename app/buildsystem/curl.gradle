import groovy.json.JsonSlurper

def executeCurlCommand(cmd, defaultReturnValue) {
  def p = cmd.execute()
  OutputStream standardOut = new ByteArrayOutputStream()
  OutputStream standardError = new ByteArrayOutputStream()
  p.waitForProcessOutput(standardOut, standardError)
  def exitValue = p.exitValue()
  if (exitValue != 0) {
    System.err.print(new String(standardError.toByteArray()))
    return defaultReturnValue
  }
  def text = new String(standardOut.toByteArray())
  if (null == text) {
    System.err.println("executeCurlCommand($cmd) text was null")
    return defaultReturnValue
  }
  new JsonSlurper().parseText(text)
}

def executePostWithData(url, json, defaultReturnValue) {
  def cmd = ['curl', '-X', 'POST', url, '-d', json]
  executeCurlCommand(cmd, defaultReturnValue)
}

def executePostWithApk(url, apkPath, defaultReturnValue) {
  def cmd = ['curl', '-X', 'POST', '-H', 'Content-Type: application/zip', '--data-binary', "@$apkPath", url]
  executeCurlCommand(cmd, defaultReturnValue)
}

def executeGet(url, defaultReturnValue) {
  def cmd = ['curl', '-X', 'GET', '-m', '20', url]
  executeCurlCommand(cmd, defaultReturnValue)
}

// Export methods by turning them into closures
ext{
  executeCurlCommand = this.&executeCurlCommand
  executePostWithData = this.&executePostWithData
  executePostWithApk = this.&executePostWithApk
  executeGet = this.&executeGet
}
